


#Load libraries
library(ROracle)
library(tidyverse)
library(ggplot2)
library(PBSmapping)
library(cowplot)
library(grid)
library(gridExtra)
library(ggpattern)

#Oracle credentials
uid <- keyring::key_list("Oracle")[1,2]
pwd <- keyring::key_get("Oracle", uid)

#Set up
path.directory <- "Y:/Inshore/BoF/"
spa3area <- read.csv("Y:/Inshore/Databases/Scallsur/SPA3/SPA3_VMSpoly.csv") #SPA3
inVMS <- read.csv("Y:/Inshore/BoF/2015/SPA6/Survey/SPA6_VMS_IN_R_final_MOD.csv") #SPA6
outvms <- read.csv("Y:/Inshore/BoF/2015/SPA6/Survey/SPA6_VMS_OUT_R_final_MOD.csv") #SPA6
chan <-dbConnect(dbDriver("Oracle"),username=uid, password=pwd,'ptran')

#Read in functions from Github
funcs <- "https://raw.githubusercontent.com/Mar-scal/Assessment_fns/master/Survey_and_OSAC/convert.dd.dddd.r"
dir <- getwd()
for(fun in funcs)
{
  temp <- dir
  download.file(fun,destfile = basename(fun))
  source(paste0(dir,"/",basename(fun)))
  file.remove(paste0(dir,"/",basename(fun)))
}

year <- 2025

#--- SPA1A ----

# read in shell height and meat weight data from database
query1 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (6,7,12,13,14,15,16,17,18,19,20,39)    ",
  sep=""
)

SPA1A.livefreq <- dbGetQuery(chan, query1)
SPA1A.livefreq  <- SPA1A.livefreq[,1:51] #remove duplicate columns


#Add up Bins >40mm and Bins >80
SPA1A.livefreq <- SPA1A.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1997) %>%
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>% # Commercial scallop - BIN_ID_80:BIN_ID_195  %>% round(0)
  mutate(rec = dplyr::select(., BIN_ID_65:BIN_ID_75) %>% rowSums(na.rm = TRUE)) %>% # Recruit scallop - BIN_ID_65:BIN_ID_75  %>% round(0)
  mutate(pre = dplyr::select(., BIN_ID_0:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(pre.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(tot.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%
  mutate(tot.all = dplyr::select(., BIN_ID_0:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA1A.tot_by_year <- SPA1A.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot.abv40 = sum(tot.abv40),
            tot.all = sum(tot.all),
            com = sum(com),
            rec = sum(rec),
            pre = sum(pre),
            pre.abv40 = sum(pre.abv40)) %>%
  mutate(com.prop.abv40 = com/tot.abv40) %>%
  mutate(com.prop.all = com/tot.all) %>%
  mutate(rec.prop.abv40 = rec/tot.abv40) %>%
  mutate(rec.prop.all = rec/tot.all) %>%
  mutate(pre.prop.abv40 = pre.abv40/tot.abv40) %>%
  mutate(pre.prop.all = pre/tot.all)

SPA1A.tot_by_year <- reshape2::melt(SPA1A.tot_by_year, id.vars = "YEAR", value.name = "value")

#Plot with pattern fill -
#plot.1A.abv40 <- ggplot(SPA1A.tot_by_year) +
#  geom_bar_pattern(data=SPA1A.tot_by_year[SPA1A.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
#           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40')),pattern=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), pattern_density = 0.3, pattern_spacing = 0.02,colour="black", stat="identity") +
#  ylab("Proportion of population (\u2265 40mm shell height)") +
#  scale_x_continuous(breaks = seq(1995, year+3, 5),
                     #labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025))+
#  scale_pattern_manual(values = c(pre.prop.abv40 ="circle", rec.prop.abv40 = "crosshatch", com.prop.abv40 ="none"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - 40mm-64mm"), name="SPA 1A") +
#  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - 40mm-64mm"), name="SPA 1A") +
#  theme_bw()+
#  theme(axis.title.x = element_blank(),
#        axis.text.x = element_text(margin = margin(t = 4)),
#        axis.title.y = element_text(margin = margin(r = 4)),
#        #legend.position = "bottom",legend.direction = "horizontal",
#        legend.key.width = unit(0.8, "cm"),
#        panel.border = element_rect(linewidth = 1, fill = NA),
#        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
#        plot.margin = margin(5, 5, 5, 1, "points"))
#plot.1A.abv40

# plot without pattern
plot.1A.abv40 <- ggplot(SPA1A.tot_by_year) +
  geom_bar(data=SPA1A.tot_by_year[SPA1A.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), colour="black", stat="identity") +
  ylab("Proportion of population (\u2265 40mm shell height)") +
  scale_x_continuous(breaks = seq(1995, year+3, 5),
  labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025))+
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial - \u2265 80mm", "Recruit - 65mm-79mm", "Pre-recruit - 40mm-64mm"), name=NULL) +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        legend.position = "bottom",legend.direction = "horizontal",
        legend.key.width = unit(0.7, "cm"), legend.text=element_text(size=8),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.1A.abv40

#save
ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA1A_clrBarplot_prop_of_pop_abv40.png", plot = plot.1A.abv40, scale = 2.5, width = 6, height = 6, dpi = 300, units = "cm", limitsize = TRUE)

# plot
plot.1A.all <- ggplot(SPA1A.tot_by_year) +
  geom_bar(data=SPA1A.tot_by_year[SPA1A.tot_by_year$variable%in%c('com.prop.all','rec.prop.all', 'pre.prop.all'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.all','rec.prop.all', 'pre.prop.all'))), colour="black", stat="identity") +
  ylab("Proportion of population (all shell heights)")+
  scale_x_continuous(breaks = seq(1995, year+3, 5),
                     labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025))+
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - \u2264 64mm"), name="SPA 1A") +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        #legend.position = c(0.2, 0.8), legend.background = element_blank(),
        legend.key.width = unit(0.8, "cm"),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.1A.all

#save
ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA1A_clrBarplot_prop_of_pop_all.png", plot = plot.1A.all, scale = 2.5, width = 8, height = 5, dpi = 300, units = "cm", limitsize = TRUE)

#--- SPA1B ----

# read in shell height and meat weight data from database
query2 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (35, 37, 38, 49, 51, 52, 53)    ",
  sep=""
)
SPA1B.livefreq <- dbGetQuery(chan, query2)
SPA1B.livefreq  <- SPA1B.livefreq[,1:51] #remove duplicate columns

#Add up Bins >40mm and Bins >80
SPA1B.livefreq  <- SPA1B.livefreq  %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1997) %>%
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>% # Commercial scallop - BIN_ID_80:BIN_ID_195  %>% round(0)
  mutate(rec = dplyr::select(., BIN_ID_65:BIN_ID_75) %>% rowSums(na.rm = TRUE)) %>% # Recruit scallop - BIN_ID_65:BIN_ID_75  %>% round(0)
  mutate(pre = dplyr::select(., BIN_ID_0:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(pre.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(tot.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%
  mutate(tot.all = dplyr::select(., BIN_ID_0:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA1B.tot_by_year <- SPA1B.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot.abv40 = sum(tot.abv40),
            tot.all = sum(tot.all),
            com = sum(com),
            rec = sum(rec),
            pre = sum(pre),
            pre.abv40 = sum(pre.abv40)) %>%
  mutate(com.prop.abv40 = com/tot.abv40) %>%
  mutate(com.prop.all = com/tot.all) %>%
  mutate(rec.prop.abv40 = rec/tot.abv40) %>%
  mutate(rec.prop.all = rec/tot.all) %>%
  mutate(pre.prop.abv40 = pre.abv40/tot.abv40) %>%
  mutate(pre.prop.all = pre/tot.all)

SPA1B.tot_by_year <- reshape2::melt(SPA1B.tot_by_year, id.vars = "YEAR", value.name = "value")


# plot
plot.1B.abv40 <- ggplot(SPA1B.tot_by_year) +
  geom_bar(data=SPA1B.tot_by_year[SPA1B.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), colour="black", stat="identity") +
  ylab("Proportion of population (\u2265 40mm shell height)") +
  scale_x_continuous(breaks = seq(1995, year+3, 5),
                     labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025))+
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial - \u2265 80mm", "Recruit - 65mm-79mm", "Pre-recruit - 40mm-64mm"), name=NULL) +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        legend.position = "bottom",legend.direction = "horizontal",
        legend.key.width = unit(0.7, "cm"), legend.text=element_text(size=8),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.1B.abv40

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA1B_clrBarplot_prop_of_pop_abv40.png", plot = plot.1B.abv40, scale = 2.5, width = 6, height = 6, dpi = 300, units = "cm", limitsize = TRUE)

# plot
plot.1B.all <- ggplot(SPA1B.tot_by_year) +
  geom_bar(data=SPA1B.tot_by_year[SPA1B.tot_by_year$variable%in%c('com.prop.all','rec.prop.all', 'pre.prop.all'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.all','rec.prop.all', 'pre.prop.all'))), colour="black", stat="identity") +
  ylab("Proportion of population (all shell heights)") +
  scale_x_continuous(breaks = seq(1995, year+3, 5),
                     labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - \u2264 64mm"), name="SPA 1B") +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        #legend.position = c(0.2, 0.8), legend.background = element_blank(),
        legend.key.width = unit(0.8, "cm"),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.1B.all

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA1B_clrBarplot_prop_of_pop_all.png", plot = plot.1B.all, scale = 2.5, width = 8, height = 5, dpi = 300, units = "cm", limitsize = TRUE)

#--- SPA3 ----

# read in shell height and meat weight data from database
query3 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (22,23,24)    ",
  sep=""
)

SPA3.livefreq <- dbGetQuery(chan, query3)
SPA3.livefreq  <- SPA3.livefreq[,1:51] #remove duplicate columns

#Want inside vms only, so need to convert latlongs
SPA3.livefreq$lat <- convert.dd.dddd(SPA3.livefreq$START_LAT)
SPA3.livefreq$lon <- convert.dd.dddd(SPA3.livefreq$START_LONG)
SPA3.livefreq$ID <- 1:nrow(SPA3.livefreq)

#identify tows "inside" the VMS strata and assign new STRATA_ID to them (99)
events <- subset(SPA3.livefreq,STRATA_ID%in%23:24,c("ID","lon","lat"))
names(events) <- c("EID","X","Y")
SPA3.livefreq$STRATA_ID[SPA3.livefreq$ID%in%findPolys(events,spa3area)$EID] <- 99

#Select tows inside VMS only, and add up Bins >40mm and Bins >80
SPA3.livefreq <- SPA3.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(STRATA_ID == 99) %>%
  filter(YEAR > 1995) %>%
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>% # Commercial scallop - BIN_ID_80:BIN_ID_195  %>% round(0)
  mutate(rec = dplyr::select(., BIN_ID_65:BIN_ID_75) %>% rowSums(na.rm = TRUE)) %>% # Recruit scallop - BIN_ID_65:BIN_ID_75  %>% round(0)
  mutate(pre = dplyr::select(., BIN_ID_0:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(pre.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(tot.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%
  mutate(tot.all = dplyr::select(., BIN_ID_0:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA3.tot_by_year <- SPA3.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot.abv40 = sum(tot.abv40),
            tot.all = sum(tot.all),
            com = sum(com),
            rec = sum(rec),
            pre = sum(pre),
            pre.abv40 = sum(pre.abv40)) %>%
  mutate(com.prop.abv40 = com/tot.abv40) %>%
  mutate(com.prop.all = com/tot.all) %>%
  mutate(rec.prop.abv40 = rec/tot.abv40) %>%
  mutate(rec.prop.all = rec/tot.all) %>%
  mutate(pre.prop.abv40 = pre.abv40/tot.abv40) %>%
  mutate(pre.prop.all = pre/tot.all)

SPA3.tot_by_year <- reshape2::melt(SPA3.tot_by_year, id.vars = "YEAR", value.name = "value")


# plot
plot.3.abv40 <- ggplot(SPA3.tot_by_year) +
  geom_bar(data=SPA3.tot_by_year[SPA3.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), colour="black", stat="identity") +
  ylab("Proportion of population (\u2265 40mm shell height)") +
  scale_x_continuous( breaks = seq(1995, year+3, 5),
  labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial - \u2265 80mm", "Recruit - 65mm-79mm", "Pre-recruit - 40mm-64mm"), name=NULL) +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        legend.position = "bottom",legend.direction = "horizontal",
        legend.key.width = unit(0.7, "cm"), legend.text=element_text(size=8),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.3.abv40

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA3_clrBarplot_prop_of_pop_abv40.png", plot = plot.3.abv40, scale = 2.5, width = 6, height = 6, dpi = 300, units = "cm", limitsize = TRUE)

# plot
plot.3.all <- ggplot(SPA3.tot_by_year) +
  geom_bar(data=SPA3.tot_by_year[SPA3.tot_by_year$variable%in%c('com.prop.all','rec.prop.all', 'pre.prop.all'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.all','rec.prop.all', 'pre.prop.all'))), colour="black", stat="identity") +
  ylab("Proportion of population (all shell heights)") +
  scale_x_continuous( breaks = seq(1995, year+3, 5),
                      labels = c(1995, 2000, 2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - \u2264 64mm"), name="SPA 3") +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        #legend.position = c(0.2, 0.8), legend.background = element_blank(),
        legend.key.width = unit(0.8, "cm"),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.3.all

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA3_clrBarplot_prop_of_pop_all.png", plot = plot.3.all, scale = 2.5, width = 8, height = 5, dpi = 300, units = "cm", limitsize = TRUE)

#--- SPA4 ----

# read in shell height and meat weight data from database
query4 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (1,2,3,4,5,8,9,10)    ",
  sep=""
)

#Select data from database; execute query with ROracle
SPA4.livefreq <- dbGetQuery(chan, query4)
SPA4.livefreq  <- SPA4.livefreq[,1:51] #remove duplicate columns

#Add up Bins >40mm and Bins >80
SPA4.livefreq <- SPA4.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1983) %>%
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>% # Commercial scallop - BIN_ID_80:BIN_ID_195  %>% round(0)
  mutate(rec = dplyr::select(., BIN_ID_65:BIN_ID_75) %>% rowSums(na.rm = TRUE)) %>% # Recruit scallop - BIN_ID_65:BIN_ID_75  %>% round(0)
  mutate(pre = dplyr::select(., BIN_ID_0:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(pre.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(tot.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%
  mutate(tot.all = dplyr::select(., BIN_ID_0:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA4.tot_by_year <- SPA4.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot.abv40 = sum(tot.abv40),
            tot.all = sum(tot.all),
            com = sum(com),
            rec = sum(rec),
            pre = sum(pre),
            pre.abv40 = sum(pre.abv40)) %>%
  mutate(com.prop.abv40 = com/tot.abv40) %>%
  mutate(com.prop.all = com/tot.all) %>%
  mutate(rec.prop.abv40 = rec/tot.abv40) %>%
  mutate(rec.prop.all = rec/tot.all) %>%
  mutate(pre.prop.abv40 = pre.abv40/tot.abv40) %>%
  mutate(pre.prop.all = pre/tot.all)

SPA4.tot_by_year <- reshape2::melt(SPA4.tot_by_year, id.vars = "YEAR", value.name = "value")


# plot
plot.4.abv40 <- ggplot(SPA4.tot_by_year) +
  geom_bar(data=SPA4.tot_by_year[SPA4.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), colour="black", stat="identity") +
  ylab("Proportion of population (\u2265 40mm shell height)") +
  scale_x_continuous(breaks = seq(1980, year+3, 5),
  labels = c(1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial - \u2265 80mm", "Recruit - 65mm-79mm", "Pre-recruit - 40mm-64mm"), name=NULL) +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        legend.position = "bottom",legend.direction = "horizontal",
        legend.key.width = unit(0.7, "cm"), legend.text=element_text(size=8),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.4.abv40

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA4_clrBarplot_prop_of_pop_abv40.png", plot = plot.4.abv40, scale = 2.5, width = 6, height = 6, dpi = 300, units = "cm", limitsize = TRUE)

# plot
plot.4.all <- ggplot(SPA4.tot_by_year) +
  geom_bar(data=SPA4.tot_by_year[SPA4.tot_by_year$variable%in%c('com.prop.all','rec.prop.all', 'pre.prop.all'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.all','rec.prop.all', 'pre.prop.all'))), colour="black", stat="identity") +
  ylab("Proportion of population (all shell heights)") +
  scale_x_continuous(breaks = seq(1980, year+3, 5),
                     labels = c(1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - \u2264 64mm"), name="SPA 4") +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        #legend.position = c(0.2, 0.8), legend.background = element_blank(),
        legend.key.width = unit(0.8, "cm"),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.4.all

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA4_clrBarplot_prop_of_pop_all.png", plot = plot.4.all, scale = 2.5, width = 8, height = 5, dpi = 300, units = "cm", limitsize = TRUE)

#--- SPA6 ----

# read in shell height and meat weight data from database
query5 <- "SELECT *
FROM scallsur.scliveres s
LEFT JOIN
(SELECT tow_date, cruise, tow_no
FROM SCALLSUR.sctows) t
on (s.cruise = t.cruise and s.tow_no = t.tow_no)
where strata_id in (30, 31, 32)"

SPA6.livefreq <- dbGetQuery(chan, query5)
SPA6.livefreq <- SPA6.livefreq[,1:51]
SPA6.livefreq$YEAR <- year(SPA6.livefreq$TOW_DATE)

#Only want data from tows inside VMS, convert lat longs
SPA6.livefreq$lat <- convert.dd.dddd(SPA6.livefreq$START_LAT)
SPA6.livefreq$lon <- convert.dd.dddd(SPA6.livefreq$START_LONG)
SPA6.livefreq$ID <- 1:nrow(SPA6.livefreq)

#identify tows "inside" the VMS strata and call them "IN" and tows "outside", "OUT".
SPA6.livefreq$VMSSTRATA <- ""
events <- subset(SPA6.livefreq,STRATA_ID%in%30:32,c("ID","lon","lat"))
names(events) <- c("EID","X","Y")
SPA6.livefreq$VMSSTRATA[SPA6.livefreq$ID%in%findPolys(events,inVMS)$EID] <- "IN"
SPA6.livefreq$VMSSTRATA[SPA6.livefreq$ID%in%findPolys(events,outvms)$EID] <- "OUT"

#Add up Bins >40mm and Bins >80
SPA6.livefreq <- SPA6.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(VMSSTRATA == "IN") %>%
  filter(YEAR >= 2006) %>%
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>% # Commercial scallop - BIN_ID_80:BIN_ID_195  %>% round(0)
  mutate(rec = dplyr::select(., BIN_ID_65:BIN_ID_75) %>% rowSums(na.rm = TRUE)) %>% # Recruit scallop - BIN_ID_65:BIN_ID_75  %>% round(0)
  mutate(pre = dplyr::select(., BIN_ID_0:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(pre.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_60) %>% rowSums(na.rm = TRUE)) %>% # Pre-recruit scallop - BIN_ID_0:BIN_ID_60 %>% round(0)
  mutate(tot.abv40 = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%
  mutate(tot.all = dplyr::select(., BIN_ID_0:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA6.tot_by_year <- SPA6.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot.abv40 = sum(tot.abv40),
            tot.all = sum(tot.all),
            com = sum(com),
            rec = sum(rec),
            pre = sum(pre),
            pre.abv40 = sum(pre.abv40)) %>%
  mutate(com.prop.abv40 = com/tot.abv40) %>%
  mutate(com.prop.all = com/tot.all) %>%
  mutate(rec.prop.abv40 = rec/tot.abv40) %>%
  mutate(rec.prop.all = rec/tot.all) %>%
  mutate(pre.prop.abv40 = pre.abv40/tot.abv40) %>%
  mutate(pre.prop.all = pre/tot.all)

SPA6.tot_by_year <- reshape2::melt(SPA6.tot_by_year, id.vars = "YEAR", value.name = "value")


# plot
plot.6.abv40 <- ggplot(SPA6.tot_by_year) +
  geom_bar(data=SPA6.tot_by_year[SPA6.tot_by_year$variable%in%c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.abv40','rec.prop.abv40', 'pre.prop.abv40'))), colour="black", stat="identity") +
  ylab("Proportion of population (\u2265 40mm shell height)") +
  scale_x_continuous(breaks = seq(2005, year+3, 5),
  labels = c(2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial - \u2265 80mm", "Recruit - 65mm-79mm", "Pre-recruit - 40mm-64mm"), name=NULL) +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        legend.position = "bottom",legend.direction = "horizontal",
        legend.key.width = unit(0.7, "cm"), legend.text=element_text(size=8),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.6.abv40

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA6_clrBarplot_prop_of_pop_abv40.png", plot = plot.6.abv40, scale = 2.5, width = 6, height = 6, dpi = 300, units = "cm", limitsize = TRUE)

# plot
plot.6.all <- ggplot(SPA6.tot_by_year) +
  geom_bar(data=SPA6.tot_by_year[SPA6.tot_by_year$variable%in%c('com.prop.all','rec.prop.all', 'pre.prop.all'),],
           aes(YEAR, value, fill=factor(variable, levels = c('com.prop.all','rec.prop.all', 'pre.prop.all'))), colour="black", stat="identity") +
  ylab("Proportion of population (all shell heights)") +
  scale_x_continuous(breaks = seq(2005, year+3, 5),
                     labels = c(2005, 2010, 2015, 2020, 2025)) +
  scale_fill_manual(values=c("red3", "yellow2", "skyblue3"), labels=c("Commercial Scallop - \u2265 80mm", "Recruit Scallop - 65mm-79mm", "Pre-recruit Scallop - \u2264 64mm"), name="SPA 6") +
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(margin = margin(t = 4)),
        axis.title.y = element_text(margin = margin(r = 4)),
        #legend.position = c(0.2, 0.8), legend.background = element_blank(),
        legend.key.width = unit(0.8, "cm"),
        panel.border = element_rect(linewidth = 1, fill = NA),
        axis.ticks = element_line(linewidth = 0.3), axis.ticks.length = unit(5, "pt"),
        plot.margin = margin(5, 5, 5, 1, "points"))
plot.6.all

ggsave(filename = "Y:/Inshore/BoF/2025/Assessment/Figures/Exploratory_plots/SPA6_clrBarplot_prop_of_pop_all.png", plot = plot.6.all, scale = 2.5, width = 8, height = 5, dpi = 300, units = "cm", limitsize = TRUE)

