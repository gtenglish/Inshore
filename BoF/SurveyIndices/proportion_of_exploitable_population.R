
#Load libraries
library(ROracle)
library(tidyverse)
library(ggplot2)
library(PBSmapping)
library(cowplot)
library(grid)
library(gridExtra)

#Oracle credentials
uid <- keyring::key_list("Oracle")[1,2]
pwd <- keyring::key_get("Oracle", uid)

#Set up
path.directory <- "Y:/Inshore/BoF/"
spa3area <- read.csv("Y:/Inshore/Databases/Scallsur/SPA3/SPA3_VMSpoly.csv") #SPA3
inVMS <- read.csv("Y:/Inshore/BoF/2015/SPA6/Survey/SPA6_VMS_IN_R_final_MOD.csv") #SPA6
outvms <- read.csv("Y:/Inshore/BoF/2015/SPA6/Survey/SPA6_VMS_OUT_R_final_MOD.csv") #SPA6
chan <-dbConnect(dbDriver("Oracle"),username=uid, password=pwd,'ptran')

#Read in functions from Github
funcs <- "https://raw.githubusercontent.com/Mar-scal/Assessment_fns/master/Survey_and_OSAC/convert.dd.dddd.r"
dir <- getwd()
for(fun in funcs)
{
  temp <- dir
  download.file(fun,destfile = basename(fun))
  source(paste0(dir,"/",basename(fun)))
  file.remove(paste0(dir,"/",basename(fun)))
}

#--- SPA1A ----

# read in shell height and meat weight data from database
query1 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (6,7,12,13,14,15,16,17,18,19,20,39)    ",
  sep=""
)

SPA1A.livefreq <- dbGetQuery(chan, query1)
SPA1A.livefreq  <- SPA1A.livefreq[,1:51] #remove duplicate columns


#Add up Bins >40mm and Bins >80
SPA1A.livefreq <- SPA1A.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1997) %>%
    mutate(tot = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%  #>40 is below quantitative limit of gear
    mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA1A.tot_by_year <- SPA1A.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot = sum(tot),
            com = sum(com)) %>%
  mutate(prop = com/tot)

SPA1A.tot_by_year <- SPA1A.tot_by_year %>%
  add_row(YEAR = 2020, tot = NA, com = NA, prop = NA) %>%
  add_row(YEAR = 1983, tot = NA, com = NA, prop = NA) #only adding so the axis labels match SPA4

ltm.SPA1A <- median(SPA1A.tot_by_year$prop, na.rm = TRUE)

#PLOT
SPA1A.plot <- ggplot(data = SPA1A.tot_by_year, mapping = aes(x = YEAR, y = prop)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 1.0, color = "red",linetype = 2) +
  geom_segment(aes(x = 1997, xend = max(YEAR), y = ltm.SPA1A, yend = ltm.SPA1A), color = "blue", linetype = "solid")+
  ylim(0, 1.0)+ xlim(1983,2025)+
  scale_x_continuous(breaks = seq(1980, 2025, by = 5))+
  labs(
    title = "SPA1A")+
  theme_bw()+
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(size = 10))
SPA1A.plot

#--- SPA1B ----

# read in shell height and meat weight data from database
query2 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (35, 37, 38, 49, 51, 52, 53)    ",
  sep=""
)
SPA1B.livefreq <- dbGetQuery(chan, query2)
SPA1B.livefreq  <- SPA1B.livefreq[,1:51] #remove duplicate columns

#Add up Bins >40mm and Bins >80
SPA1B.livefreq <- SPA1B.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1997) %>%
  mutate(tot = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%  #>40 is below quantitative limit of gear
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA1B.tot_by_year <- SPA1B.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot = sum(tot),
            com = sum(com)) %>%
  mutate(prop = com/tot)

SPA1B.tot_by_year <- SPA1B.tot_by_year %>%
  add_row(YEAR = 2020, tot = NA, com = NA, prop = NA) %>%
add_row(YEAR = 1983, tot = NA, com = NA, prop = NA) #only adding so the axis labels match SPA4

ltm.SPA1B <- median(SPA1B.tot_by_year$prop, na.rm = TRUE)

#PLOT
SPA1B.plot <- ggplot(data = SPA1B.tot_by_year, mapping = aes(x = YEAR, y = prop)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 1.0, color = "red",linetype = 2) +
  geom_segment(aes(x = 1997, xend = max(YEAR), y = ltm.SPA1B, yend = ltm.SPA1B), color = "blue", linetype = "solid")+
  ylim(0, 1.0)+ xlim(1983,2025)+
  scale_x_continuous(breaks = seq(1980, 2025, by = 5))+
  labs(
    title = "SPA1B")+
  theme_bw()+
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(size = 10))
SPA1B.plot

#--- SPA3 ----

# read in shell height and meat weight data from database
query3 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (22,23,24)    ",
  sep=""
)

SPA3.livefreq <- dbGetQuery(chan, query3)
SPA3.livefreq  <- SPA3.livefreq[,1:51] #remove duplicate columns

#Want inside vms only, so need to convert latlongs
SPA3.livefreq$lat <- convert.dd.dddd(SPA3.livefreq$START_LAT)
SPA3.livefreq$lon <- convert.dd.dddd(SPA3.livefreq$START_LONG)
SPA3.livefreq$ID <- 1:nrow(SPA3.livefreq)

#identify tows "inside" the VMS strata and assign new STRATA_ID to them (99)
events <- subset(SPA3.livefreq,STRATA_ID%in%23:24,c("ID","lon","lat"))
names(events) <- c("EID","X","Y")
SPA3.livefreq$STRATA_ID[SPA3.livefreq$ID%in%findPolys(events,spa3area)$EID] <- 99

#Select tows inside VMS only, and add up Bins >40mm and Bins >80
SPA3.livefreq <- SPA3.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(STRATA_ID == 99) %>%
  filter(YEAR > 1995) %>%
  mutate(tot = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%  #>40 is below quantitative limit of gear
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA3.tot_by_year <- SPA3.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot = sum(tot),
            com = sum(com)) %>%
  mutate(prop = com/tot)

SPA3.tot_by_year <- SPA3.tot_by_year %>%
  add_row(YEAR = 2020, tot = NA, com = NA, prop = NA)%>%
  add_row(YEAR = 1983, tot = NA, com = NA, prop = NA) #only adding so the axis labels match SPA4

ltm.SPA3 <- median(SPA3.tot_by_year$prop, na.rm = TRUE)

#PLOT
SPA3.plot <- ggplot(data = SPA3.tot_by_year, mapping = aes(x = YEAR, y = prop)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 1.0, color = "red",linetype = 2) +
  geom_segment(aes(x = 1996, xend = max(YEAR), y = ltm.SPA3, yend = ltm.SPA3), color = "blue", linetype = "solid")+
  ylim(0, 1.0)+ xlim(1983,2025)+
  scale_x_continuous(breaks = seq(1980, 2025, by = 5))+
  labs(
    title = "SPA3")+
  theme_bw()+
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(size = 10))
SPA3.plot

#--- SPA4 ----

# read in shell height and meat weight data from database
query4 <- paste(
  "SELECT * 			                ",
  "FROM scallsur.scliveres s			",
  " LEFT JOIN                          ",
  " 	(SELECT tow_date, cruise, tow_no     ",
  "	 FROM SCALLSUR.sctows) t             ",
  "on (s.cruise = t.cruise and s.tow_no = t.tow_no)",
  "where strata_id in (1,2,3,4,5,8,9,10)    ",
  sep=""
)

#Select data from database; execute query with ROracle
SPA4.livefreq <- dbGetQuery(chan, query4)
SPA4.livefreq  <- SPA4.livefreq[,1:51] #remove duplicate columns

#Add up Bins >40mm and Bins >80
SPA4.livefreq <- SPA4.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(YEAR >= 1983) %>%
  mutate(tot = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%  #>40 is below quantitative limit of gear
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA4.tot_by_year <- SPA4.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot = sum(tot),
            com = sum(com)) %>%
  mutate(prop = com/tot)

SPA4.tot_by_year <- SPA4.tot_by_year %>%
  add_row(YEAR = 2020, tot = NA, com = NA, prop = NA)

ltm.SPA4 <- median(SPA4.tot_by_year$prop, na.rm = TRUE)

#PLOT
SPA4.plot <- ggplot(data = SPA4.tot_by_year, mapping = aes(x = YEAR, y = prop)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 1.0, color = "red",linetype = 2) +
  geom_segment(aes(x = 1983, xend = max(YEAR), y = ltm.SPA4, yend = ltm.SPA4), color = "blue", linetype = "solid")+
  ylim(0, 1.0)+ xlim(1983,2025)+
  scale_x_continuous(breaks = seq(1980, 2025, by = 5))+
  labs(
    title = "SPA4")+
  theme_bw()+
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(size = 10))
SPA4.plot

#--- SPA6 ----

# read in shell height and meat weight data from database
query5 <- "SELECT *
FROM scallsur.scliveres s
LEFT JOIN
(SELECT tow_date, cruise, tow_no
FROM SCALLSUR.sctows) t
on (s.cruise = t.cruise and s.tow_no = t.tow_no)
where strata_id in (30, 31, 32)"

SPA6.livefreq <- dbGetQuery(chan, query5)
SPA6.livefreq <- SPA6.livefreq[,1:51]
SPA6.livefreq$YEAR <- year(SPA6.livefreq$TOW_DATE)

#Only want data from tows inside VMS, convert lat longs
SPA6.livefreq$lat <- convert.dd.dddd(SPA6.livefreq$START_LAT)
SPA6.livefreq$lon <- convert.dd.dddd(SPA6.livefreq$START_LONG)
SPA6.livefreq$ID <- 1:nrow(SPA6.livefreq)

#identify tows "inside" the VMS strata and call them "IN" and tows "outside", "OUT".
SPA6.livefreq$VMSSTRATA <- ""
events <- subset(SPA6.livefreq,STRATA_ID%in%30:32,c("ID","lon","lat"))
names(events) <- c("EID","X","Y")
SPA6.livefreq$VMSSTRATA[SPA6.livefreq$ID%in%findPolys(events,inVMS)$EID] <- "IN"
SPA6.livefreq$VMSSTRATA[SPA6.livefreq$ID%in%findPolys(events,outvms)$EID] <- "OUT"

#Add up Bins >40mm and Bins >80
SPA6.livefreq <- SPA6.livefreq %>%
  mutate(YEAR = year(TOW_DATE)) %>%  #Formats TOW_DATE as date
  filter(VMSSTRATA == "IN") %>%
  filter(YEAR >= 2006) %>%
  mutate(tot = dplyr::select(., BIN_ID_40:BIN_ID_195) %>% rowSums(na.rm = TRUE)) %>%  #>40 is below quantitative limit of gear
  mutate(com = dplyr::select(., BIN_ID_80:BIN_ID_195) %>% rowSums(na.rm = TRUE))

#Summarize: Group by Year
SPA6.tot_by_year <- SPA6.livefreq %>%
  group_by(YEAR) %>%
  summarise(tot = sum(tot),
            com = sum(com)) %>%
  mutate(prop = com/tot)

SPA6.tot_by_year <- SPA6.tot_by_year %>%
  add_row(YEAR = 2020, tot = NA, com = NA, prop = NA)%>%
  add_row(YEAR = 1983, tot = NA, com = NA, prop = NA) #only adding so the axis labels match SPA4

ltm.SPA6 <- median(SPA6.tot_by_year$prop, na.rm = TRUE)

#PLOT
SPA6.plot <- ggplot(data = SPA6.tot_by_year, mapping = aes(x = YEAR, y = prop)) +
  geom_point()+
  geom_line()+
  geom_hline(yintercept = 1.0, color = "red",linetype = 2) +
  geom_segment(aes(x = 2006, xend = max(YEAR), y = ltm.SPA6, yend = ltm.SPA6), color = "blue", linetype = "solid")+
  ylim(0, 1.0)+ xlim(1983,2025)+
  scale_x_continuous(breaks = seq(1980, 2025, by = 5))+
  labs(
    title = "SPA6")+
  theme_bw()+
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), plot.title = element_text(size = 10))
SPA6.plot

######## Combine Plots #################################################################################

panel <- cowplot::plot_grid(SPA1A.plot, SPA1B.plot, SPA3.plot, SPA4.plot, SPA6.plot,ncol=1,axis="lr")
panel

y.grob <- textGrob("Proportion of population \u2265 80 mm",
                   gp=gpar(col="black", fontsize=12), rot=90)

x.grob <- textGrob("Year",
                   gp=gpar(col="black", fontsize=12))

plot.final <- grid.arrange(arrangeGrob(panel, left = y.grob, bottom = x.grob))

#Saved manually as Y:\Inshore\BoF\2025\Assessment\Figures\Proportion_of_100plus_Scallops_in_Survey_Tows_2025.png, width = 469, Height = 718
